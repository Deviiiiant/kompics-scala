<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Serialisation · Kompics</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content='Kompics-Scala-Docs'/>
<link href="https://fonts.googleapis.com/css?family=Roboto:100normal,100italic,300normal,300italic,400normal,400italic,500normal,500italic,700normal,700italic,900normal,900italicc" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../../../js/page.js"></script>
<script type="text/javascript" src="../../../js/warnOldVersion.js"></script>
<script type="text/javascript" src="../../../js/groups.js"></script>
<link rel="stylesheet" type="text/css" href="../../../lib/foundation/dist/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="../../../css/page.css"/>

<!--
<link rel="shortcut icon" href="../../../images/favicon.ico" />
-->
</head>

<body>
<div class="off-canvas-wrapper">
<div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>

<div class="off-canvas position-left" id="off-canvas-menu" data-off-canvas>
<nav class="off-canvas-nav">
<div class="nav-home">
<a href="../../../index.html" >
<span class="home-icon">⌂</span>Kompics
</a>
<div class="version-number">
2.0.0
</div>
</div>
<select class="supergroup" name="Language"><option class="group" value="group-scala">Scala</option><option class="group" value="group-java">Java</option></select>
<div class="nav-toc">
<ul>
  <li><a href="../../../introduction/index.html" class="page">Introduction</a>
  <ul>
    <li><a href="../../../introduction/whatiskompics.html" class="page">What is Kompics?</a></li>
    <li><a href="../../../introduction/gettingstarted.html" class="page">Getting Started</a></li>
    <li><a href="../../../introduction/helloworld.html" class="page">Hello World in Kompics</a></li>
  </ul></li>
  <li><a href="../../../tutorial/index.html" class="page">Kompics Tutorial</a>
  <ul>
    <li><a href="../../../tutorial/basics.html" class="page">Kompics Basics</a></li>
    <li><a href="../../../tutorial/timers.html" class="page">Timers</a></li>
    <li><a href="../../../tutorial/networking/index.html" class="page">Networking</a></li>
    <li><a href="../../../tutorial/simulation/index.html" class="page">Simulation</a></li>
  </ul></li>
  <li><a href="../../../reference.html" class="page">Reference</a></li>
</ul>
</div>

</nav>
</div>

<div class="off-canvas-content" data-off-canvas-content>

<header class="site-header expanded row">
<div class="small-12 column">
<a href="#" class="off-canvas-toggle hide-for-medium" data-toggle="off-canvas-menu"><svg class="svg-icon svg-icon-menu" version="1.1" id="Menu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"> <path class="svg-icon-menu-path" fill="#53CDEC" d="M16.4,9H3.6C3.048,9,3,9.447,3,10c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,9.447,16.952,9,16.4,9z M16.4,13
H3.6C3.048,13,3,13.447,3,14c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,13.447,16.952,13,16.4,13z M3.6,7H16.4
C16.952,7,17,6.553,17,6c0-0.553-0.048-1-0.6-1H3.6C3.048,5,3,5.447,3,6C3,6.553,3.048,7,3.6,7z"/></svg>
</a>
<div class="title"><a href="../../../index.html">Kompics</a></div>

<!--
<a href="https://www.example.com" class="logo show-for-medium">logo</a>
-->
</div>
</header>

<div class="expanded row">

<div class="medium-3 large-2 show-for-medium column">
<nav class="site-nav">
<div class="nav-home">
<a href="../../../index.html" >
<span class="home-icon">⌂</span>Kompics
</a>
<div class="version-number">
2.0.0
</div>
</div>
<select class="supergroup" name="Language"><option class="group" value="group-scala">Scala</option><option class="group" value="group-java">Java</option></select>
<div class="nav-toc">
<ul>
  <li><a href="../../../introduction/index.html" class="page">Introduction</a>
  <ul>
    <li><a href="../../../introduction/whatiskompics.html" class="page">What is Kompics?</a></li>
    <li><a href="../../../introduction/gettingstarted.html" class="page">Getting Started</a></li>
    <li><a href="../../../introduction/helloworld.html" class="page">Hello World in Kompics</a></li>
  </ul></li>
  <li><a href="../../../tutorial/index.html" class="page">Kompics Tutorial</a>
  <ul>
    <li><a href="../../../tutorial/basics.html" class="page">Kompics Basics</a></li>
    <li><a href="../../../tutorial/timers.html" class="page">Timers</a></li>
    <li><a href="../../../tutorial/networking/index.html" class="page">Networking</a></li>
    <li><a href="../../../tutorial/simulation/index.html" class="page">Simulation</a></li>
  </ul></li>
  <li><a href="../../../reference.html" class="page">Reference</a></li>
</ul>
</div>

</nav>
</div>

<div class="small-12 medium-9 large-10 column">
<section class="site-content">

<span id="version-warning"></span>

<div class="page-header row">
<div class="medium-12 show-for-medium column">
<div class="nav-breadcrumbs">
<ul>
  <li><a href="../../../index.html">Kompics</a></li>
  <li><a href="../../../tutorial/index.html">Kompics Tutorial</a></li>
  <li><a href="../../../tutorial/networking/index.html">Networking</a></li>
  <li><a href="../../../tutorial/networking/basic/index.html">Basic Networking</a></li>
  <li>Serialisation</li>
</ul>
</div>
</div>
</div>

<div class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h2><a href="#serialisation" name="serialisation" class="anchor"><span class="anchor-link"></span></a>Serialisation</h2>
<p>With <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-component-netty-network/1.2.1/se/sics/kompics/network/netty/NettyNetwork.html" title="se.sics.kompics.network.netty.NettyNetwork"><code>NettyNetwork</code></a> comes a serialisation framework that builds on Netty&rsquo;s <a href="https://netty.io/4.1/api/?io/netty/buffer/ByteBuf.html" title="io.netty.buffer.ByteBuf"><code>ByteBuf</code></a> facilities. The Kompics part is two-fold: It consists of the <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-component-netty-network/1.2.1/se/sics/kompics/network/netty/serialization/Serializer.html" title="se.sics.kompics.network.netty.serialization.Serializer"><code>Serializer</code></a> interface, and a registration, mapping, and lookup service for such serialisers in <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-component-netty-network/1.2.1/se/sics/kompics/network/netty/serialization/Serializers.html" title="se.sics.kompics.network.netty.serialization.Serializers"><code>Serializers</code></a>.</p>
<h3><a href="#serialiser-identifiers" name="serialiser-identifiers" class="anchor"><span class="anchor-link"></span></a>Serialiser Identifiers</h3>
<p>For every <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-component-netty-network/1.2.1/se/sics/kompics/network/netty/serialization/Serializer.html" title="se.sics.kompics.network.netty.serialization.Serializer"><code>Serializer</code></a> you write and register you will be required to pick a unique <span class="group-java"><code>int</code></span><span class="group-scala"><code>Int</code></span> identifier. You are required to keep track of the identifiers you use yourself. Kompics reserves the range 0-16 for internal use. By default only a single <span class="group-java"><code>byte</code></span><span class="group-scala"><code>Byte</code></span> worth of identifier space is used, in order to minimise the overhead of the framework. If you are assigning larger identifiers than 255 (or their signed equivalents), make sure to use the <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-component-netty-network/1.2.1/se/sics/kompics/network/netty/serialization/Serializers.html#resize(se.sics.kompics.network.netty.serialization.Serializers.IdBytes)" title="se.sics.kompics.network.netty.serialization.Serializers"><code>resize</code></a> method <em>before</em> registering the respective serialisers.</p><div class="callout note "><div class="callout-title">Note</div>
<p>For larger projects it can become quite difficult to keep track of which identifiers are used and which are free. It is recommended to either assign them all in a single place (e.g., <span class="group-java">static fields of a class</span><span class="group-scala">fields of an object</span>, or a configuration file), or assign subranges to submodules of the project and then do the same single-location-assignment per module.</p></div>
<h3><a href="#serialiser-methods" name="serialiser-methods" class="anchor"><span class="anchor-link"></span></a>Serialiser Methods</h3>
<p>When implementing the <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-component-netty-network/1.2.1/se/sics/kompics/network/netty/serialization/Serializer.html#toBinary(java.lang.Object,io.netty.buffer.ByteBuf)" title="se.sics.kompics.network.netty.serialization.Serializer"><code>toBinary</code></a> and <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-component-netty-network/1.2.1/se/sics/kompics/network/netty/serialization/Serializer.html#fromBinary(io.netty.buffer.ByteBuf,java.util.Optional)" title="se.sics.kompics.network.netty.serialization.Serializer"><code>fromBinary</code></a> methods you are free to do as you like, as long as at the end of <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-component-netty-network/1.2.1/se/sics/kompics/network/netty/serialization/Serializer.html#toBinary(java.lang.Object,io.netty.buffer.ByteBuf)" title="se.sics.kompics.network.netty.serialization.Serializer"><code>toBinary</code></a> the whole object is in the <a href="https://netty.io/4.1/api/?io/netty/buffer/ByteBuf.html" title="io.netty.buffer.ByteBuf"><code>ByteBuf</code></a> and at the end of <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-component-netty-network/1.2.1/se/sics/kompics/network/netty/serialization/Serializer.html#fromBinary(io.netty.buffer.ByteBuf,java.util.Optional)" title="se.sics.kompics.network.netty.serialization.Serializer"><code>fromBinary</code></a> the same number of bytes that you put into the <a href="https://netty.io/4.1/api/?io/netty/buffer/ByteBuf.html" title="io.netty.buffer.ByteBuf"><code>ByteBuf</code></a> are removed from it again.</p>
<h3><a href="#serializers" name="serializers" class="anchor"><span class="anchor-link"></span></a>Serializers</h3>
<p>The <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-component-netty-network/1.2.1/se/sics/kompics/network/netty/serialization/Serializers.html" title="se.sics.kompics.network.netty.serialization.Serializers"><code>Serializers</code></a> singleton class has two important functions. First, it registers serialisers into the system, so that they can be looked up when messages come in that have been serialised with them (as defined by their identifier). And second, it maps <em>types</em> to specific <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-component-netty-network/1.2.1/se/sics/kompics/network/netty/serialization/Serializer.html" title="se.sics.kompics.network.netty.serialization.Serializer"><code>Serializer</code></a> instances that are already registered. The most convenient way to do that is by registering a short name to the serialiser instance via <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-component-netty-network/1.2.1/se/sics/kompics/network/netty/serialization/Serializers.html#register(se.sics.kompics.network.netty.serialization.Serializer,java.lang.String)" title="se.sics.kompics.network.netty.serialization.Serializers"><code>register(Serializer, String)</code></a>, and then register the class mappings to that name using <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-component-netty-network/1.2.1/se/sics/kompics/network/netty/serialization/Serializers.html#register(java.lang.Class,java.lang.String)" title="se.sics.kompics.network.netty.serialization.Serializers"><code>register(Class, String)</code></a>. Alternatively, the identifier can be used as well with <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-component-netty-network/1.2.1/se/sics/kompics/network/netty/serialization/Serializers.html#register(java.lang.Class,int)" title="se.sics.kompics.network.netty.serialization.Serializers"><code>register(Class, int)</code></a> or both can be achieved at once for a single type-serialiser-mapping using <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-component-netty-network/1.2.1/se/sics/kompics/network/netty/serialization/Serializers.html#register(java.lang.Class,se.sics.kompics.network.netty.serialization.Serializer)" title="se.sics.kompics.network.netty.serialization.Serializers"><code>register(Class, Serializer)</code></a>.</p>
<p>The lookup of serialisers for types is hierarchical, that is, when there is no exact mapping found for the type, the system will traverse its type hierarchy upwards to find a matching supertype <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-component-netty-network/1.2.1/se/sics/kompics/network/netty/serialization/Serializer.html" title="se.sics.kompics.network.netty.serialization.Serializer"><code>Serializer</code></a> and attempt to use that one instead. For example, if the object to be serialised implements Java&rsquo;s <a href="https://docs.oracle.com/en/java/javase/13/docs/api/java.base/java/io/Serializable.html" title="java.io.Serializable"><code>Serializable</code></a> interface and there is no more specific <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-component-netty-network/1.2.1/se/sics/kompics/network/netty/serialization/Serializer.html" title="se.sics.kompics.network.netty.serialization.Serializer"><code>Serializer</code></a> registered, the object will be serialised with Java object serialisation (which is registered by default).</p>
<h3><a href="#default-serialisers" name="default-serialisers" class="anchor"><span class="anchor-link"></span></a>Default Serialisers</h3>
<p>The other default serialisers (and their identifiers) are:</p>
<ul>
  <li>With id=0: <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-component-netty-network/1.2.1/se/sics/kompics/network/netty/serialization/SpecialSerializers.NullSerializer.html" title="se.sics.kompics.network.netty.serialization.SpecialSerializers.NullSerializer"><code>NullSerializer</code></a> for <code>null</code></li>
  <li>With id=1: <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-component-netty-network/1.2.1/se/sics/kompics/network/netty/serialization/SpecialSerializers.ByteSerializer.html" title="se.sics.kompics.network.netty.serialization.SpecialSerializers.ByteSerializer"><code>ByteSerializer</code></a> for <span class="group-java"><code>byte[]</code></span><span class="group-scala"><code>Array[Byte]</code></span></li>
  <li>With id=2: <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-component-netty-network/1.2.1/se/sics/kompics/network/netty/serialization/SpecialSerializers.AddressSerializer.html" title="se.sics.kompics.network.netty.serialization.SpecialSerializers.AddressSerializer"><code>AddressSerializer</code></a> for <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-component-netty-network/1.2.1/se/sics/kompics/network/netty/NettyAddress.html" title="se.sics.kompics.network.netty.NettyAddress"><code>NettyAddress</code></a></li>
  <li>With id=3: <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-component-netty-network/1.2.1/se/sics/kompics/network/netty/serialization/JavaSerializer.html" title="se.sics.kompics.network.netty.serialization.JavaSerializer"><code>JavaSerializer</code></a> for anything that implements <a href="https://docs.oracle.com/en/java/javase/13/docs/api/java.base/java/io/Serializable.html" title="java.io.Serializable"><code>Serializable</code></a></li>
  <li>With id=4: <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-component-netty-network/1.2.1/se/sics/kompics/network/netty/serialization/ProtobufSerializer.html" title="se.sics.kompics.network.netty.serialization.ProtobufSerializer"><code>ProtobufSerializer</code></a> for <a href="https://developers.google.com/protocol-buffers/?hl=en" title="Protocol Buffers">Protocol Buffers</a> (not registered by default)</li>
  <li>With id=5: <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-component-netty-network/1.2.1/se/sics/kompics/network/netty/NettySerializer.html" title="se.sics.kompics.network.netty.NettySerializer"><code>NettySerializer</code></a> for <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-component-netty-network/1.2.1/se/sics/kompics/network/netty/NettyNetwork.html" title="se.sics.kompics.network.netty.NettyNetwork"><code>NettyNetwork</code></a> internal messages</li>
  <li>With id=6: <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-component-netty-network/1.2.1/se/sics/kompics/network/netty/serialization/SpecialSerializers.UUIDSerializer.html" title="se.sics.kompics.network.netty.serialization.SpecialSerializers.UUIDSerializer"><code>UUIDSerializer</code></a> for <a href="https://docs.oracle.com/en/java/javase/13/docs/api/java.base/java/util/UUID.html" title="java.util.UUID"><code>UUID</code></a></li>
  <li>With id=7: <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-component-netty-network/1.2.1/se/sics/kompics/network/netty/serialization/AvroSerializer.html" title="se.sics.kompics.network.netty.serialization.AvroSerializer"><code>AvroSerializer</code></a> for <a href="https://avro.apache.org/" title="Avro">Avro</a> (not registered by default)</li>
  <li>Ids 8 to 16 are reserved for future additions</li>
</ul><div class="callout note "><div class="callout-title">Note</div>
<p>For people familiar with common Java serialisation frameworks it might be obvious that <a href="https://github.com/EsotericSoftware/kryo" title="Kryo">Kryo</a> is missing from the above list. This is on purpose. Kompics&rsquo; previous messaging middleware used to rely on Kryo for serialisation, but Kryo&rsquo;s low level object layout hacks lead to a host of problems with deployments that included different types of JVMs (e.g., Oracle JRE and Open JRE, or different versions). For this reason we have purposefully moved away from Kryo serialisation. You are welcome to implement your own Kryo-based <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-component-netty-network/1.2.1/se/sics/kompics/network/netty/serialization/Serializer.html" title="se.sics.kompics.network.netty.serialization.Serializer"><code>Serializer</code></a>, just know that in some setups you might encounter a lot of very difficult to pinpoint bugs.</p></div>
<h3><a href="#pingpong-serialisers" name="pingpong-serialisers" class="anchor"><span class="anchor-link"></span></a>PingPong Serialisers</h3>
<p>In our <em>PingPong</em> example, the classes that need to be serialised are: <code>TAddress</code>, <code>THeader</code>, <code>Ping</code>, and <code>Pong</code>. Note that there is no necessesity to serialise <code>TMessage</code> separately from <code>Ping</code> and <code>Pong</code> at this point, as it has no content of its own and cannot be instantied. Of course, we could simply have all of those classes implement <a href="https://docs.oracle.com/en/java/javase/13/docs/api/java.base/java/io/Serializable.html" title="java.io.Serializable"><code>Serializable</code></a> <span class="group-scala">(as the case classes already do)</span> and be done with it. Since this is a tutorial (and Java&rsquo;s object serialisation is terribly inefficient), we are instead going to write our own custom serialisers. As preparation for future sections and to show off the system, we will split the serialisation logic into two classes: <code>NetSerializer</code> will deal with <code>TAddress</code> and <code>THeader</code> instances, while <code>PingPongSerializer</code> will deal with <code>Ping</code> and <code>Pong</code> messages. Since <code>THeader</code> is part of the messages, we will of course call the <code>NetSerializer</code> from the <code>PingPongSerializer</code>, but we will act as if we do not know what kind of <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-port-network/1.2.1/se/sics/kompics/network/Header.html" title="se.sics.kompics.network.Header"><code>Header</code></a> we are dealing with and let the serialisation framework figure that out. Similarly, <code>TAddress</code>es are part of a <code>THeader</code>, so we will invoke the <code>NetSerializer</code> from itself. Note, that the difference between two approaches is whether or not the serialiser&rsquo;s identifier will be prepended. If we invoke a serialiser directly from within another serialiser, it is assumed that it will be known at serialisation and deserialisation time what the object is and the identifier can be omitted. If we instead use the <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-component-netty-network/1.2.1/se/sics/kompics/network/netty/serialization/Serializers.html" title="se.sics.kompics.network.netty.serialization.Serializers"><code>Serializers</code></a> facilities, the system will keep track of that itself using the identifier.</p>
<p>In order to keep our identifier spaces separate we&rsquo;ll pick id=100 for the <code>NetSerializer</code> and id=200 for the <code>PingPongSerializer</code>. And since we only have two instances to deal with, we&rsquo;ll just define the identifiers within the classes in the lazy way. </p>
<p><span class="group-java">We also added some extra constructors to the messages, to make it easier to pass <code>THeader</code> instances from another serialiser during deserialisation.</span></p>
<h4><a href="#netserializer" name="netserializer" class="anchor"><span class="anchor-link"></span></a>NetSerializer</h4>
<dl>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/kompics/kompics-scala/tree/v2.0.0/docs/src/main/java/jexamples/networking/pingpongdistributed/NetSerializer.java" target="_blank" title="Go to snippet source"></a><code class="language-java">package jexamples.networking.pingpongdistributed;

import io.netty.buffer.ByteBuf;
import java.net.InetAddress;
import java.net.UnknownHostException;

import java.util.Optional;
import se.sics.kompics.network.Transport;
import se.sics.kompics.network.netty.serialization.Serializer;

public class NetSerializer implements Serializer {

  private static final byte ADDR = 1;
  private static final byte HEADER = 2;

  @Override
  public int identifier() {
    return 100;
  }

  @Override
  public void toBinary(Object o, ByteBuf buf) {
    if (o instanceof TAddress) {
      TAddress addr = (TAddress) o;
      buf.writeByte(ADDR); // mark which type we are serialising (1 byte)
      buf.writeBytes(addr.getIp().getAddress()); // 4 bytes IP (let&#39;s assumee it&#39;s IPv4)
      buf.writeShort(addr.getPort()); // we only need 2 bytes here
      // total 7 bytes
    } else if (o instanceof THeader) {
      THeader header = (THeader) o;
      buf.writeByte(HEADER); // mark which type we are serialising (1 byte)
      this.toBinary(header.src, buf); // use this serialiser again (7 bytes)
      this.toBinary(header.dst, buf); // use this serialiser again (7 bytes)
      buf.writeByte(header.proto.ordinal()); // 1 byte is enough
      // total 16 bytes
    }
  }

  @Override
  public Object fromBinary(ByteBuf buf, Optional&lt;Object&gt; hint) {
    byte type = buf.readByte(); // read the first byte to figure out the type
    switch (type) {
      case ADDR:
        {
          byte[] ipBytes = new byte[4];
          buf.readBytes(ipBytes);
          try {
            InetAddress ip = InetAddress.getByAddress(ipBytes); // 4 bytes
            int port = buf.readUnsignedShort(); // 2 bytes
            return new TAddress(ip, port); // total of 7, check
          } catch (UnknownHostException ex) {
            throw new RuntimeException(ex); // let Netty deal with this
          }
        }
      case HEADER:
        {
          TAddress src =
              (TAddress)
                  this.fromBinary(
                      buf, Optional.empty()); // We already know what it&#39;s going to be (7 bytes)
          TAddress dst = (TAddress) this.fromBinary(buf, Optional.empty()); // same here (7 bytes)
          int protoOrd = buf.readByte(); // 1 byte
          Transport proto = Transport.values()[protoOrd];
          return new THeader(src, dst, proto); // total of 16 bytes, check
        }
    }
    return null; // strange things happened^^
  }
}</code></pre></dd>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/kompics/kompics-scala/tree/v2.0.0/docs/src/main/scala/sexamples/networking/pingpongdistributed/NetSerializer.scala" target="_blank" title="Go to snippet source"></a><code class="language-scala">package sexamples.networking.pingpongdistributed

import io.netty.buffer.ByteBuf
import java.net.{InetAddress, UnknownHostException}
import java.util.Optional
import se.sics.kompics.network.Transport
import se.sics.kompics.network.netty.serialization.Serializer

object NetSerializer extends Serializer {
  private val ADDR: Byte = 1;
  private val HEADER: Byte = 2;

  private val NO_HINT: Optional[AnyRef] = Optional.empty();

  override def identifier(): Int = 100;

  override def toBinary(o: AnyRef, buf: ByteBuf): Unit = {
    o match {
      case addr: TAddress =&gt; {
        buf.writeByte(ADDR); // mark which type we are serialising (1 byte)
        buf.writeBytes(addr.getIp().getAddress()); // 4 bytes IP (let&#39;s assume it&#39;s IPv4)
        buf.writeShort(addr.getPort()); // we only need 2 bytes here
        // total 7 bytes
      }
      case header: THeader =&gt; {
        buf.writeByte(HEADER); // mark which type we are serialising (1 byte)
        this.toBinary(header.src, buf); // use this serialiser again (7 bytes)
        this.toBinary(header.dst, buf); // use this serialiser again (7 bytes)
        buf.writeByte(header.proto.ordinal()); // 1 byte is enough
        // total 16 bytes
      }
    }
  }

  override def fromBinary(buf: ByteBuf, hint: Optional[AnyRef]): AnyRef = {
    val typeFlag = buf.readByte(); // read the first byte to figure out the type
    typeFlag match {
      case ADDR =&gt; {
        val ipBytes = Array.ofDim[Byte](4);
        buf.readBytes(ipBytes);
        val ip = InetAddress.getByAddress(ipBytes); // 4 bytes
        val port = buf.readUnsignedShort(); // 2 bytes
        return TAddress(ip, port); // total of 7, check
      }
      case HEADER =&gt; {
        val src = this.fromBinary(buf, NO_HINT).asInstanceOf[TAddress]; // We already know what it&#39;s going to be (7 bytes)
        val dst = this.fromBinary(buf, NO_HINT).asInstanceOf[TAddress]; // We already know what it&#39;s going to be (7 bytes)
        val protoOrd = buf.readByte(); // 1 byte
        val proto = Transport.values()(protoOrd);
        return THeader(src, dst, proto); // total of 16 bytes, check
      }
      case _ =&gt; {
        Console.err.println(s&quot;Got invalid byte flag=$typeFlag&quot;);
        return null;
      }
    }
  }
}</code></pre></dd>
</dl>
<h4><a href="#pingpongserializer" name="pingpongserializer" class="anchor"><span class="anchor-link"></span></a>PingPongSerializer</h4>
<dl>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/kompics/kompics-scala/tree/v2.0.0/docs/src/main/java/jexamples/networking/pingpongdistributed/PingPongSerializer.java" target="_blank" title="Go to snippet source"></a><code class="language-java">package jexamples.networking.pingpongdistributed;

import java.util.Optional;
import io.netty.buffer.ByteBuf;
import se.sics.kompics.network.netty.serialization.Serializer;
import se.sics.kompics.network.netty.serialization.Serializers;

public class PingPongSerializer implements Serializer {

  private static final byte PING = 1;
  private static final byte PONG = 2;

  @Override
  public int identifier() {
    return 200;
  }

  @Override
  public void toBinary(Object o, ByteBuf buf) {
    if (o instanceof Ping) {
      Ping ping = (Ping) o;
      buf.writeByte(PING); // 1 byte
      Serializers.toBinary(ping.header, buf); // 1 byte serialiser id + 16 bytes THeader
      // total 18 bytes
    } else if (o instanceof Pong) {
      Pong pong = (Pong) o;
      buf.writeByte(PONG); // 1 byte
      Serializers.toBinary(pong.header, buf); // 1 byte serialiser id + 16 bytes THeader
      // total 18 bytes
    }
  }

  @Override
  public Object fromBinary(ByteBuf buf, Optional&lt;Object&gt; hint) {
    byte type = buf.readByte(); // 1 byte
    switch (type) {
      case PING:
        {
          THeader header =
              (THeader)
                  Serializers.fromBinary(
                      buf, Optional.empty()); // 1 byte serialiser id + 16 bytes THeader
          return new Ping(header); // 18 bytes total, check
        }
      case PONG:
        {
          THeader header =
              (THeader)
                  Serializers.fromBinary(
                      buf, Optional.empty()); // 1 byte serialiser id + 16 bytes THeader
          return new Pong(header); // 18 bytes total, check
        }
    }
    return null;
  }
}</code></pre></dd>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/kompics/kompics-scala/tree/v2.0.0/docs/src/main/scala/sexamples/networking/pingpongdistributed/PingPongSerializer.scala" target="_blank" title="Go to snippet source"></a><code class="language-scala">package sexamples.networking.pingpongdistributed

import io.netty.buffer.ByteBuf
import java.net.{InetAddress, UnknownHostException}
import java.util.Optional
import se.sics.kompics.network.Transport
import se.sics.kompics.network.netty.serialization.{Serializer, Serializers}

object PingPongSerializer extends Serializer {
  private val PING: Byte = 1;
  private val PONG: Byte = 2;

  private val NO_HINT: Optional[AnyRef] = Optional.empty();

  override def identifier(): Int = 200;

  override def toBinary(o: AnyRef, buf: ByteBuf): Unit = {
    o match {
      case ping: Ping =&gt; {
        buf.writeByte(PING); // 1 byte
        Serializers.toBinary(ping.header, buf); // 1 byte serialiser id + 16 bytes THeader
        // total 18 bytes
      }
      case pong: Pong =&gt; {
        buf.writeByte(PONG); // 1 byte
        Serializers.toBinary(pong.header, buf); // 1 byte serialiser id + 16 bytes THeader
        // total 18 bytes
      }
    }
  }

  override def fromBinary(buf: ByteBuf, hint: Optional[AnyRef]): AnyRef = {
    val typeFlag = buf.readByte(); // 1 byte
    typeFlag match {
      case PING =&gt; {
        val header = Serializers.fromBinary(buf, NO_HINT).asInstanceOf[THeader]; // 1 byte serialiser id + 16 bytes THeader
        return new Ping(header); // 18 bytes total, check
      }
      case PONG =&gt; {
        val header = Serializers.fromBinary(buf, NO_HINT).asInstanceOf[THeader]; // 1 byte serialiser id + 16 bytes THeader
        return new Pong(header); // 18 bytes total, check
      }
      case _ =&gt; {
        Console.err.println(s&quot;Got invalid byte flag=$typeFlag&quot;);
        return null;
      }
    }
  }
}</code></pre></dd>
</dl><div class="callout note "><div class="callout-title">Note</div>
<p>The serialisation above code is not particularly space efficient, since that was not the purpose. To get an idea how to use bit-fields to get a significant space reduction on these kind of frequently used serialisation procedures, take a look at the source code of the <a href="https://github.com/kompics/kompics/blob/master/basic/component-netty-network/src/main/java/se/sics/kompics/network/netty/serialization/SpecialSerializers.java">SpecialSerializers class</a>.</p></div>
<p>All that is left is now is to register the new serialisers and map the right types to them. We add the following to the <code>Main</code> <span class="group-java">class</span><span class="group-scala">object</span>:</p>
<dl>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/kompics/kompics-scala/tree/v2.0.0/docs/src/main/java/jexamples/networking/pingpongdistributed/Main.java#L11-L20" target="_blank" title="Go to snippet source"></a><code class="language-java">static {
  // register
  Serializers.register(new NetSerializer(), &quot;netS&quot;);
  Serializers.register(new PingPongSerializer(), &quot;ppS&quot;);
  // map
  Serializers.register(TAddress.class, &quot;netS&quot;);
  Serializers.register(THeader.class, &quot;netS&quot;);
  Serializers.register(Ping.class, &quot;ppS&quot;);
  Serializers.register(Pong.class, &quot;ppS&quot;);
}</code></pre></dd>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/kompics/kompics-scala/tree/v2.0.0/docs/src/main/scala/sexamples/networking/pingpongdistributed/Main.scala#L10-L17" target="_blank" title="Go to snippet source"></a><code class="language-scala">// register
Serializers.register(NetSerializer, &quot;netS&quot;);
Serializers.register(PingPongSerializer, &quot;ppS&quot;);
// map
Serializers.register(classOf[TAddress], &quot;netS&quot;);
Serializers.register(classOf[THeader], &quot;netS&quot;);
Serializers.register(classOf[Ping], &quot;ppS&quot;);
Serializers.register(classOf[Pong], &quot;ppS&quot;);</code></pre></dd>
</dl>
<h2><a href="#distributed-pingpong" name="distributed-pingpong" class="anchor"><span class="anchor-link"></span></a>Distributed PingPong</h2>
<p>Now we are prepared for a true distributed deployment of our <em>PingPong</em> example. There are a number of changes we need to make to the way we set up the component hierarchy. First of all, we want to deploy <code>Pinger</code> and <code>Ponger</code> separately, and they also need different parameters. The <code>Ponger</code> is purely reactive and it only needs to know its own <em>self</em> address. The <code>Pinger</code>, on the other hand, needs to know both its own address and a <code>Ponger</code>&rsquo;s. We are going to make use of that distinction in the <code>Main</code> <span class="group-java">class</span><span class="group-scala">object</span>, in order to decide which one to start. If we see <em>two</em> commandline arguments (1 IP and 1 port), we are going to start a <code>Ponger</code>. If, however, we see <em>four</em> commandline arguments (2 IPs and 2 ports), we are going to start a <code>Pinger</code>. Since our application components now need different setup, we are also going to split the <code>Parent</code> into a <code>PingerParent</code> and a <code>PongerParent</code>. Note, that it is always a good idea to have a class without any business logic that sets up the <code>Network</code> and <code>Timer</code> connections, as you will see in the section on <a href="../../simulation/index.html">simulation</a>.</p>
<h4><a href="#pingerparent" name="pingerparent" class="anchor"><span class="anchor-link"></span></a>PingerParent</h4>
<dl>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/kompics/kompics-scala/tree/v2.0.0/docs/src/main/java/jexamples/networking/pingpongdistributed/PingerParent.java" target="_blank" title="Go to snippet source"></a><code class="language-java">package jexamples.networking.pingpongdistributed;

import se.sics.kompics.Channel;
import se.sics.kompics.Component;
import se.sics.kompics.ComponentDefinition;
import se.sics.kompics.network.Network;
import se.sics.kompics.network.netty.NettyInit;
import se.sics.kompics.network.netty.NettyNetwork;
import se.sics.kompics.timer.Timer;
import se.sics.kompics.timer.java.JavaTimer;

public class PingerParent extends ComponentDefinition {

  public PingerParent(Init init) {
    Component timer = create(JavaTimer.class, Init.NONE);
    Component network = create(NettyNetwork.class, new NettyInit(init.self));
    Component pinger = create(Pinger.class, new Pinger.Init(init.self, init.ponger));

    connect(pinger.getNegative(Timer.class), timer.getPositive(Timer.class), Channel.TWO_WAY);

    connect(pinger.getNegative(Network.class), network.getPositive(Network.class), Channel.TWO_WAY);
  }

  public static class Init extends se.sics.kompics.Init&lt;PingerParent&gt; {

    public final TAddress self;
    public final TAddress ponger;

    public Init(TAddress self, TAddress ponger) {
      this.self = self;
      this.ponger = ponger;
    }
  }
}</code></pre></dd>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/kompics/kompics-scala/tree/v2.0.0/docs/src/main/scala/sexamples/networking/pingpongdistributed/Parent.scala#L10-L21" target="_blank" title="Go to snippet source"></a><code class="language-scala">class PingerParent(init: Init[PingerParent]) extends ComponentDefinition {

  val Init(self: TAddress, ponger: TAddress) = init;

  val timer = create[JavaTimer];
  val network = create[NettyNetwork](new NettyInit(self));
  val pinger = create[Pinger](Init[Pinger](self, ponger));

  connect[Timer](timer -&gt; pinger);

  connect[Network](network -&gt; pinger);
}</code></pre></dd>
</dl>
<h4><a href="#pongerparent" name="pongerparent" class="anchor"><span class="anchor-link"></span></a>PongerParent</h4>
<dl>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/kompics/kompics-scala/tree/v2.0.0/docs/src/main/java/jexamples/networking/pingpongdistributed/PongerParent.java" target="_blank" title="Go to snippet source"></a><code class="language-java">package jexamples.networking.pingpongdistributed;

import se.sics.kompics.Channel;
import se.sics.kompics.Component;
import se.sics.kompics.ComponentDefinition;
import se.sics.kompics.network.Network;
import se.sics.kompics.network.netty.NettyInit;
import se.sics.kompics.network.netty.NettyNetwork;

public class PongerParent extends ComponentDefinition {

  public PongerParent(Init init) {
    Component network = create(NettyNetwork.class, new NettyInit(init.self));
    Component ponger = create(Ponger.class, new Ponger.Init(init.self));

    connect(ponger.getNegative(Network.class), network.getPositive(Network.class), Channel.TWO_WAY);
  }

  public static class Init extends se.sics.kompics.Init&lt;PongerParent&gt; {

    public final TAddress self;

    public Init(TAddress self) {
      this.self = self;
    }
  }
}</code></pre></dd>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/kompics/kompics-scala/tree/v2.0.0/docs/src/main/scala/sexamples/networking/pingpongdistributed/Parent.scala#L25-L33" target="_blank" title="Go to snippet source"></a><code class="language-scala">class PongerParent(init: Init[PongerParent]) extends ComponentDefinition {

  val Init(self: TAddress) = init;

  val network = create[NettyNetwork](new NettyInit(self));
  val ponger = create[Ponger](Init[Ponger](self));

  connect[Network](network -&gt; ponger);
}</code></pre></dd>
</dl>
<h4><a href="#main" name="main" class="anchor"><span class="anchor-link"></span></a>Main</h4>
<dl>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/kompics/kompics-scala/tree/v2.0.0/docs/src/main/java/jexamples/networking/pingpongdistributed/Main.java" target="_blank" title="Go to snippet source"></a><code class="language-java">package jexamples.networking.pingpongdistributed;

import java.net.InetAddress;
import java.net.UnknownHostException;
import se.sics.kompics.Kompics;
import se.sics.kompics.network.netty.serialization.Serializers;

public class Main {

  static {
    // register
    Serializers.register(new NetSerializer(), &quot;netS&quot;);
    Serializers.register(new PingPongSerializer(), &quot;ppS&quot;);
    // map
    Serializers.register(TAddress.class, &quot;netS&quot;);
    Serializers.register(THeader.class, &quot;netS&quot;);
    Serializers.register(Ping.class, &quot;ppS&quot;);
    Serializers.register(Pong.class, &quot;ppS&quot;);
  }

  public static void main(String[] args) {
    try {
      if (args.length == 2) { // start Ponger
        InetAddress ip = InetAddress.getByName(args[0]);
        int port = Integer.parseInt(args[1]);
        TAddress self = new TAddress(ip, port);
        Kompics.createAndStart(PongerParent.class, new PongerParent.Init(self), 2);
        System.out.println(&quot;Starting Ponger at &quot; + self);
        Kompics.waitForTermination();
        // will never actually terminate...act like a server and keep running until externally
        // exited
      } else if (args.length == 4) { // start Pinger
        InetAddress myIp = InetAddress.getByName(args[0]);
        int myPort = Integer.parseInt(args[1]);
        TAddress self = new TAddress(myIp, myPort);
        InetAddress pongerIp = InetAddress.getByName(args[2]);
        int pongerPort = Integer.parseInt(args[3]);
        TAddress ponger = new TAddress(pongerIp, pongerPort);
        Kompics.createAndStart(PingerParent.class, new PingerParent.Init(self, ponger), 2);
        System.out.println(&quot;Starting Pinger at&quot; + self + &quot; to &quot; + ponger);
        Kompics.waitForTermination();
        System.exit(0);
      } else {
        System.err.println(&quot;Invalid number of parameters (2 for Ponger, 4 for Pinger)&quot;);
        System.exit(1);
      }
    } catch (UnknownHostException ex) {
      System.err.println(ex);
      System.exit(1);
    } catch (InterruptedException ex) {
      System.err.println(ex);
      System.exit(1);
    }
  }
}</code></pre></dd>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/kompics/kompics-scala/tree/v2.0.0/docs/src/main/scala/sexamples/networking/pingpongdistributed/Main.scala" target="_blank" title="Go to snippet source"></a><code class="language-scala">package sexamples.networking.pingpongdistributed

import se.sics.kompics.sl._
import se.sics.kompics.network.netty.serialization.Serializers
import java.net.{InetAddress, UnknownHostException}

object Main {

  // register
  Serializers.register(NetSerializer, &quot;netS&quot;);
  Serializers.register(PingPongSerializer, &quot;ppS&quot;);
  // map
  Serializers.register(classOf[TAddress], &quot;netS&quot;);
  Serializers.register(classOf[THeader], &quot;netS&quot;);
  Serializers.register(classOf[Ping], &quot;ppS&quot;);
  Serializers.register(classOf[Pong], &quot;ppS&quot;);

  def main(args: Array[String]): Unit = {
    if (args.length == 2) { // start Ponger
      val ip = InetAddress.getByName(args(0));
      val port = Integer.parseInt(args(1));
      val self = TAddress(ip, port);
      Kompics.createAndStart(classOf[PongerParent], Init[PongerParent](self), 2);
      println(s&quot;Starting Ponger at $self&quot;);
      Kompics.waitForTermination();
      // will never actually terminate...act like a server and keep running until externally exited
    } else if (args.length == 4) {
      val ip = InetAddress.getByName(args(0));
      val port = Integer.parseInt(args(1));
      val self = TAddress(ip, port);
      val pongerIp = InetAddress.getByName(args(2));
      val pongerPort = Integer.parseInt(args(3));
      val ponger = TAddress(pongerIp, pongerPort);
      Kompics.createAndStart(classOf[PingerParent], Init[PingerParent](self, ponger), 2);
      Kompics.waitForTermination();
      System.exit(0);
    } else {
      System.err.println(&quot;Invalid number of parameters (2 for Ponger, 4 for Pinger)&quot;);
      System.exit(1);
    }
  }
}</code></pre></dd>
</dl>
<h3><a href="#execution" name="execution" class="anchor"><span class="anchor-link"></span></a>Execution</h3>
<p>Now we are finally ready to try this. The following commands should be run in different terminals (different sbt instances), preferably side by side so you can clearly see how things are happening. For all the examples, feel free to change the IPs and ports as you like, but be sure they match up correctly.</p>
<p>Start the <code>Ponger</code> first with:</p><div class="group-java">
<pre class="prettyprint"><code class="language-bash">runMain jexamples.networking.pingpongdistributed.Main 127.0.0.1 34567
</code></pre></div><div class="group-scala">
<pre class="prettyprint"><code class="language-bash">runMain sexamples.networking.pingpongdistributed.Main 127.0.0.1 34567
</code></pre></div>
<p>Then start a <code>Pinger</code> with:</p><div class="group-java">
<pre class="prettyprint"><code class="language-bash">runMain jexamples.networking.pingpongdistributed.Main 127.0.0.1 34568 127.0.0.1 34567
</code></pre></div><div class="group-scala">
<pre class="prettyprint"><code class="language-bash">runMain sexamples.networking.pingpongdistributed.Main 127.0.0.1 34568 127.0.0.1 34567
</code></pre></div>
<p>You can start the same <code>Pinger</code> multiple times or start as many <code>Pinger</code> JVMs in parallel as you like. Make sure they all have their own port, though!</p>
<p>You will see that there is no <code>Ping</code> amplification anymore as we saw in the last example. All messages are now correctly addressed and replied to. If you struggle to clearly see what is going on among all the logging output, try to reduce the logging level to <code>info</code> in the <a href="https://github.com/kompics/kompics-scala/tree/v2.0.0/docs/src/main/resources/logback.xml">logback.xml</a> file. Finally, use <code>Control-c</code> to shutdown the <code>Ponger</code>, as it will run forever otherwise.</p>
<div class="source-github">
The source code for this page can be found <a href="https://github.com/kompics/kompics-scala/tree/v2.0.0/docs/src/main/paradox/tutorial/networking/basic/serialisation.md">here</a>.
</div>

<div class="nav-next">
<p><strong>Next:</strong> <a href="../../../tutorial/networking/basic/cleanup.html">Cleanup</a></p>
</div>
</div>
<div class="large-3 show-for-large column" data-sticky-container>
<nav class="sidebar sticky" data-sticky data-anchor="docs" data-sticky-on="large">
<div class="page-nav">
<div class="nav-title">On this page:</div>
<div class="nav-toc">
<ul>
  <li><a href="../../../tutorial/networking/basic/serialisation.html#serialisation" class="header">Serialisation</a>
  <ul>
    <li><a href="../../../tutorial/networking/basic/serialisation.html#serialiser-identifiers" class="header">Serialiser Identifiers</a></li>
    <li><a href="../../../tutorial/networking/basic/serialisation.html#serialiser-methods" class="header">Serialiser Methods</a></li>
    <li><a href="../../../tutorial/networking/basic/serialisation.html#serializers" class="header">Serializers</a></li>
    <li><a href="../../../tutorial/networking/basic/serialisation.html#default-serialisers" class="header">Default Serialisers</a></li>
    <li><a href="../../../tutorial/networking/basic/serialisation.html#pingpong-serialisers" class="header">PingPong Serialisers</a></li>
    <li><a href="../../../tutorial/networking/basic/serialisation.html#distributed-pingpong" class="header">Distributed PingPong</a></li>
  </ul></li>
</ul>
</div>
</div>
</nav>
</div>
</div>

</section>
</div>

</div>

<footer class="site-footer">

<section class="site-footer-nav">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 medium-4 large-3 text-center column">
<div class="nav-links">
<ul>
<!-- <li><a href="https://www.example.com/products/">Products</a> -->
</ul>
</div>
</div>

</div>
</div>
</div>
</section>

<section class="site-footer-base">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 text-center large-9 column">

<!--
<div class="copyright">
<span class="text">&copy; 2020</span>
<a href="https://www.example.com" class="logo">logo</a>
</div>
-->
</div>

</div>
</div>
</div>
</section>
</footer>

</div>
</div>
</div>
</body>

<script type="text/javascript" src="../../../lib/foundation/dist/foundation.min.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../../../js/magellan.js"></script>

<style type="text/css">@import "../../../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../../../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../../../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>
<script type="text/javascript">jQuery(function(jq){initOldVersionWarnings(jq, '2.0.0', '')});</script>


</html>
