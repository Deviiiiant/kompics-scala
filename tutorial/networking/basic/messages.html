<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Messages, Addresses, and Headers · Kompics</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content='Kompics-Scala-Docs'/>
<link href="https://fonts.googleapis.com/css?family=Roboto:100normal,100italic,300normal,300italic,400normal,400italic,500normal,500italic,700normal,700italic,900normal,900italicc" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../../../js/page.js"></script>
<script type="text/javascript" src="../../../js/warnOldVersion.js"></script>
<script type="text/javascript" src="../../../js/groups.js"></script>
<link rel="stylesheet" type="text/css" href="../../../lib/foundation/dist/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="../../../css/page.css"/>

<!--
<link rel="shortcut icon" href="../../../images/favicon.ico" />
-->
</head>

<body>
<div class="off-canvas-wrapper">
<div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>

<div class="off-canvas position-left" id="off-canvas-menu" data-off-canvas>
<nav class="off-canvas-nav">
<div class="nav-home">
<a href="../../../index.html" >
<span class="home-icon">⌂</span>Kompics
</a>
<div class="version-number">
2.0.0
</div>
</div>
<select class="supergroup" name="Language"><option class="group" value="group-scala">Scala</option><option class="group" value="group-java">Java</option></select>
<div class="nav-toc">
<ul>
  <li><a href="../../../introduction/index.html" class="page">Introduction</a>
  <ul>
    <li><a href="../../../introduction/whatiskompics.html" class="page">What is Kompics?</a></li>
    <li><a href="../../../introduction/gettingstarted.html" class="page">Getting Started</a></li>
    <li><a href="../../../introduction/helloworld.html" class="page">Hello World in Kompics</a></li>
  </ul></li>
  <li><a href="../../../tutorial/index.html" class="page">Kompics Tutorial</a>
  <ul>
    <li><a href="../../../tutorial/basics.html" class="page">Kompics Basics</a></li>
    <li><a href="../../../tutorial/timers.html" class="page">Timers</a></li>
    <li><a href="../../../tutorial/networking/index.html" class="page">Networking</a></li>
    <li><a href="../../../tutorial/simulation/index.html" class="page">Simulation</a></li>
  </ul></li>
  <li><a href="../../../reference.html" class="page">Reference</a></li>
</ul>
</div>

</nav>
</div>

<div class="off-canvas-content" data-off-canvas-content>

<header class="site-header expanded row">
<div class="small-12 column">
<a href="#" class="off-canvas-toggle hide-for-medium" data-toggle="off-canvas-menu"><svg class="svg-icon svg-icon-menu" version="1.1" id="Menu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"> <path class="svg-icon-menu-path" fill="#53CDEC" d="M16.4,9H3.6C3.048,9,3,9.447,3,10c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,9.447,16.952,9,16.4,9z M16.4,13
H3.6C3.048,13,3,13.447,3,14c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,13.447,16.952,13,16.4,13z M3.6,7H16.4
C16.952,7,17,6.553,17,6c0-0.553-0.048-1-0.6-1H3.6C3.048,5,3,5.447,3,6C3,6.553,3.048,7,3.6,7z"/></svg>
</a>
<div class="title"><a href="../../../index.html">Kompics</a></div>

<!--
<a href="https://www.example.com" class="logo show-for-medium">logo</a>
-->
</div>
</header>

<div class="expanded row">

<div class="medium-3 large-2 show-for-medium column">
<nav class="site-nav">
<div class="nav-home">
<a href="../../../index.html" >
<span class="home-icon">⌂</span>Kompics
</a>
<div class="version-number">
2.0.0
</div>
</div>
<select class="supergroup" name="Language"><option class="group" value="group-scala">Scala</option><option class="group" value="group-java">Java</option></select>
<div class="nav-toc">
<ul>
  <li><a href="../../../introduction/index.html" class="page">Introduction</a>
  <ul>
    <li><a href="../../../introduction/whatiskompics.html" class="page">What is Kompics?</a></li>
    <li><a href="../../../introduction/gettingstarted.html" class="page">Getting Started</a></li>
    <li><a href="../../../introduction/helloworld.html" class="page">Hello World in Kompics</a></li>
  </ul></li>
  <li><a href="../../../tutorial/index.html" class="page">Kompics Tutorial</a>
  <ul>
    <li><a href="../../../tutorial/basics.html" class="page">Kompics Basics</a></li>
    <li><a href="../../../tutorial/timers.html" class="page">Timers</a></li>
    <li><a href="../../../tutorial/networking/index.html" class="page">Networking</a></li>
    <li><a href="../../../tutorial/simulation/index.html" class="page">Simulation</a></li>
  </ul></li>
  <li><a href="../../../reference.html" class="page">Reference</a></li>
</ul>
</div>

</nav>
</div>

<div class="small-12 medium-9 large-10 column">
<section class="site-content">

<span id="version-warning"></span>

<div class="page-header row">
<div class="medium-12 show-for-medium column">
<div class="nav-breadcrumbs">
<ul>
  <li><a href="../../../index.html">Kompics</a></li>
  <li><a href="../../../tutorial/index.html">Kompics Tutorial</a></li>
  <li><a href="../../../tutorial/networking/index.html">Networking</a></li>
  <li><a href="../../../tutorial/networking/basic/index.html">Basic Networking</a></li>
  <li>Messages, Addresses, and Headers</li>
</ul>
</div>
</div>
</div>

<div class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h2><a href="#messages-addresses-and-headers" name="messages-addresses-and-headers" class="anchor"><span class="anchor-link"></span></a>Messages, Addresses, and Headers</h2>
<p>The <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-port-network/1.2.1/se/sics/kompics/network/Network.html" title="se.sics.kompics.network.Network"><code>Network</code></a> port only allows three kinds of events: A <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-port-network/1.2.1/se/sics/kompics/network/Msg.html" title="se.sics.kompics.network.Msg"><code>Msg</code></a> may pass in both directions (indication and request), while <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-port-network/1.2.1/se/sics/kompics/network/MessageNotify.Req.html" title="se.sics.kompics.network.MessageNotify.Req"><code>MessageNotify.Req</code></a> is a request and <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-port-network/1.2.1/se/sics/kompics/network/MessageNotify.Resp.html" title="se.sics.kompics.network.MessageNotify.Resp"><code>MessageNotify.Resp</code></a> is an indication. The latter two can be used to ask the <code>Network</code> service for feedback about whether or not a specific message was sent, how long it took, and how big the serialised version was. This is convenient for systems that need to keep statistics about their messages, or where resources should be freed as soon as a message crosses the wire. All messages that go over the network have to implement the <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-port-network/1.2.1/se/sics/kompics/network/Msg.html" title="se.sics.kompics.network.Msg"><code>Msg</code></a> interface, which merely stipulates that a message has to have some kind of <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-port-network/1.2.1/se/sics/kompics/network/Header.html" title="se.sics.kompics.network.Header"><code>Header</code></a>. The deprecated methods still need to be implemented for backwards compatibility, but should simply forward fields from the header.</p>
<h3><a href="#header" name="header" class="anchor"><span class="anchor-link"></span></a>Header</h3>
<p>The header itself requires three fields:</p>
<ol>
  <li>A <strong>source</strong> address, which on the sender side is typically the <em>self</em> address of the node, and on the receiver side refers to the sender.</li>
  <li>A <strong>destination</strong> address, which tells the network on the sender side, where the message should go, and is typically the <em>self</em> address on the receiver side.</li>
  <li>The <strong>transport</strong> protocol to be used for the message. There is no requirement for all <code>Network</code> implementations to implement all possible protocols. <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-component-netty-network/1.2.1/se/sics/kompics/network/netty/NettyNetwork.html" title="se.sics.kompics.network.netty.NettyNetwork"><code>NettyNetwork</code></a> implements <code>TCP</code>, <code>UDP</code>, and <code>UDT</code> only.</li>
</ol>
<h3><a href="#address" name="address" class="anchor"><span class="anchor-link"></span></a>Address</h3>
<p>The <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-port-network/1.2.1/se/sics/kompics/network/Address.html" title="se.sics.kompics.network.Address"><code>Address</code></a> interface has four required methods:</p>
<ol>
  <li><a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-port-network/1.2.1/se/sics/kompics/network/Address.html#getIp()" title="se.sics.kompics.network.Address"><code>IP</code></a> and</li>
  <li><a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-port-network/1.2.1/se/sics/kompics/network/Address.html#getPort()" title="se.sics.kompics.network.Address"><code>port</code></a> are pretty self explanatory.</li>
  <li><a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-port-network/1.2.1/se/sics/kompics/network/Address.html#asSocket()" title="se.sics.kompics.network.Address"><code>asSocket</code></a> should get a combined represenation of IP and port. It is strongly recommended to keep the internal representation of the address as <a href="https://docs.oracle.com/en/java/javase/13/docs/api/java.base/java/net/InetSocketAddress.html" title="java.net.InetSocketAddress"><code>InetSocketAddress</code></a>, since this method will be called a lot more often than the first two, and creating a new object for it on the fly is rather expensive.</li>
  <li>Finally, the <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-port-network/1.2.1/se/sics/kompics/network/Address.html#sameHostAs(se.sics.kompics.network.Address)" title="se.sics.kompics.network.Address"><code>sameHostAs</code></a> method is used for avoiding serialisation overhead when the message would end up in the same JVM anyway. This can be used for local addressing of components and is typically important for <a href="../virtual/index.html">virtual nodes</a>, where components on the same JVM will often communicate via the network port.</li>
</ol><div class="callout note "><div class="callout-title">Note</div>
<p>None of the interface presented above make any requirements as to the (im-)mutability of their fields. It is generally recommended to make all of them immutable whenever possible. However, certain setups may require mutable headers, for example. A routing component might be implemented in such a way.</p></div>
<h3><a href="#implementations" name="implementations" class="anchor"><span class="anchor-link"></span></a>Implementations</h3>
<p>Since almost all application will need custom fields in addition to the fields in the <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-port-network/1.2.1/se/sics/kompics/network/Msg.html" title="se.sics.kompics.network.Msg"><code>Msg</code></a>, <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-port-network/1.2.1/se/sics/kompics/network/Header.html" title="se.sics.kompics.network.Header"><code>Header</code></a>, or <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-port-network/1.2.1/se/sics/kompics/network/Address.html" title="se.sics.kompics.network.Address"><code>Address</code></a> interfaces, almost everyone will want to write their own implementations. However, if that should not be the case, a simple default implementation can be found in <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-component-netty-network/1.2.1/se/sics/kompics/network/netty/DirectMessage.html" title="se.sics.kompics.network.netty.DirectMessage"><code>netty.DirectMessage</code></a>, <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-component-netty-network/1.2.1/se/sics/kompics/network/netty/DirectHeader.html" title="se.sics.kompics.network.netty.DirectHeader"><code>netty.DirectHeader</code></a>, and <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-component-netty-network/1.2.1/se/sics/kompics/network/netty/NettyAddress.html" title="se.sics.kompics.network.netty.NettyAddress"><code>NettyAddress</code></a>. For the purpose of this tutorial, however, we will write our own, which we will prefix with the letter <strong>T</strong> (for <em>Tutorial</em>) to easily differentiate it from the interfaces.</p>
<h4><a href="#taddress" name="taddress" class="anchor"><span class="anchor-link"></span></a>TAddress</h4>
<dl>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/kompics/kompics-scala/tree/v2.0.0/docs/src/main/java/jexamples/networking/pingpong/TAddress.java" target="_blank" title="Go to snippet source"></a><code class="language-java">package jexamples.networking.pingpong;

import java.net.InetAddress;
import java.net.InetSocketAddress;
import se.sics.kompics.network.Address;

public class TAddress implements Address {

  private final InetSocketAddress isa;

  public TAddress(InetAddress addr, int port) {
    this.isa = new InetSocketAddress(addr, port);
  }

  @Override
  public InetAddress getIp() {
    return this.isa.getAddress();
  }

  @Override
  public int getPort() {
    return this.isa.getPort();
  }

  @Override
  public InetSocketAddress asSocket() {
    return this.isa;
  }

  @Override
  public boolean sameHostAs(Address other) {
    return this.isa.equals(other.asSocket());
  }

  // Not required but strongly recommended

  @Override
  public final String toString() {
    return isa.toString();
  }

  @Override
  public int hashCode() {
    int hash = 3;
    hash = 11 * hash + (this.isa != null ? this.isa.hashCode() : 0);
    return hash;
  }

  @Override
  public boolean equals(Object obj) {
    if (obj == null) {
      return false;
    }
    if (getClass() != obj.getClass()) {
      return false;
    }
    final TAddress other = (TAddress) obj;
    if (this.isa != other.isa &amp;&amp; (this.isa == null || !this.isa.equals(other.isa))) {
      return false;
    }
    return true;
  }
}</code></pre></dd>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/kompics/kompics-scala/tree/v2.0.0/docs/src/main/scala/sexamples/networking/pingpong/Messages.scala#L8-L22" target="_blank" title="Go to snippet source"></a><code class="language-scala">object TAddress {
  def apply(addr: InetAddress, port: Int): TAddress = {
    val isa = new InetSocketAddress(addr, port);
    TAddress(isa)
  }
}
case class TAddress(isa: InetSocketAddress) extends Address {

  override def getIp(): InetAddress = isa.getAddress();
  override def getPort(): Int = isa.getPort();
  override def asSocket(): InetSocketAddress = isa;
  override def sameHostAs(other: Address): Boolean = {
    this.isa.equals(other.asSocket())
  }
}</code></pre></dd>
</dl>
<h4><a href="#theader" name="theader" class="anchor"><span class="anchor-link"></span></a>THeader</h4>
<dl>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/kompics/kompics-scala/tree/v2.0.0/docs/src/main/java/jexamples/networking/pingpong/THeader.java" target="_blank" title="Go to snippet source"></a><code class="language-java">package jexamples.networking.pingpong;

import se.sics.kompics.network.Address;
import se.sics.kompics.network.Header;
import se.sics.kompics.network.Transport;

public class THeader implements Header&lt;TAddress&gt; {

  public final TAddress src;
  public final TAddress dst;
  public final Transport proto;

  public THeader(TAddress src, TAddress dst, Transport proto) {
    this.src = src;
    this.dst = dst;
    this.proto = proto;
  }

  @Override
  public TAddress getSource() {
    return src;
  }

  @Override
  public TAddress getDestination() {
    return dst;
  }

  @Override
  public Transport getProtocol() {
    return proto;
  }
}</code></pre></dd>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/kompics/kompics-scala/tree/v2.0.0/docs/src/main/scala/sexamples/networking/pingpong/Messages.scala#L26-L30" target="_blank" title="Go to snippet source"></a><code class="language-scala">case class THeader(src: TAddress, dst: TAddress, proto: Transport) extends Header[TAddress] {
  override def getSource(): TAddress = src;
  override def getDestination(): TAddress = dst;
  override def getProtocol(): Transport = proto;
}</code></pre></dd>
</dl>
<h4><a href="#tmessage" name="tmessage" class="anchor"><span class="anchor-link"></span></a>TMessage</h4>
<dl>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/kompics/kompics-scala/tree/v2.0.0/docs/src/main/java/jexamples/networking/pingpong/TMessage.java" target="_blank" title="Go to snippet source"></a><code class="language-java">package jexamples.networking.pingpong;

import se.sics.kompics.network.Address;
import se.sics.kompics.network.Header;
import se.sics.kompics.network.Msg;
import se.sics.kompics.network.Transport;

public abstract class TMessage implements Msg&lt;TAddress, THeader&gt; {

  public final THeader header;

  public TMessage(TAddress src, TAddress dst, Transport protocol) {
    this.header = new THeader(src, dst, protocol);
  }

  @Override
  public THeader getHeader() {
    return this.header;
  }

  @SuppressWarnings(&quot;deprecation&quot;)
  @Override
  public TAddress getSource() {
    return this.header.src;
  }

  @SuppressWarnings(&quot;deprecation&quot;)
  @Override
  public TAddress getDestination() {
    return this.header.dst;
  }

  @SuppressWarnings(&quot;deprecation&quot;)
  @Override
  public Transport getProtocol() {
    return this.header.proto;
  }
}</code></pre></dd>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/kompics/kompics-scala/tree/v2.0.0/docs/src/main/scala/sexamples/networking/pingpong/Messages.scala#L34-L43" target="_blank" title="Go to snippet source"></a><code class="language-scala">abstract class TMessage(val header: THeader) extends Msg[TAddress, THeader] {
  def this(src: TAddress, dst: TAddress, proto: Transport) {
    this(THeader(src, dst, proto))
  }

  override def getHeader(): THeader = header;
  override def getSource(): TAddress = header.src;
  override def getDestination(): TAddress = header.dst;
  override def getProtocol(): Transport = header.proto;
}</code></pre></dd>
</dl>
<p>For our <em>PingPong</em> example we shall have both <code>Ping</code> and <code>Pong</code> extend <code>TMessage</code> instead of using the direct request-response. We also hard-code <code>TCP</code> as protocol for both for now.</p>
<h4><a href="#ping" name="ping" class="anchor"><span class="anchor-link"></span></a>Ping</h4>
<dl>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/kompics/kompics-scala/tree/v2.0.0/docs/src/main/java/jexamples/networking/pingpong/Ping.java" target="_blank" title="Go to snippet source"></a><code class="language-java">package jexamples.networking.pingpong;

import se.sics.kompics.network.Transport;

public class Ping extends TMessage {
  public Ping(TAddress src, TAddress dst) {
    super(src, dst, Transport.TCP);
  }
}</code></pre></dd>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/kompics/kompics-scala/tree/v2.0.0/docs/src/main/scala/sexamples/networking/pingpong/Messages.scala#L54-L57" target="_blank" title="Go to snippet source"></a><code class="language-scala">object Ping {
  def apply(src: TAddress, dst: TAddress): Ping = new Ping(THeader(src, dst, Transport.TCP));
}
class Ping(_header: THeader) extends TMessage(_header);</code></pre></dd>
</dl>
<h4><a href="#pong" name="pong" class="anchor"><span class="anchor-link"></span></a>Pong</h4>
<dl>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/kompics/kompics-scala/tree/v2.0.0/docs/src/main/java/jexamples/networking/pingpong/Pong.java" target="_blank" title="Go to snippet source"></a><code class="language-java">package jexamples.networking.pingpong;

import se.sics.kompics.network.Transport;

public class Pong extends TMessage {
  public Pong(TAddress src, TAddress dst) {
    super(src, dst, Transport.TCP);
  }
}</code></pre></dd>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/kompics/kompics-scala/tree/v2.0.0/docs/src/main/scala/sexamples/networking/pingpong/Messages.scala#L47-L50" target="_blank" title="Go to snippet source"></a><code class="language-scala">object Pong {
  def apply(src: TAddress, dst: TAddress): Pong = new Pong(THeader(src, dst, Transport.TCP));
}
class Pong(_header: THeader) extends TMessage(_header);</code></pre></dd>
</dl>
<p>Now we need to change the <code>Pinger</code> and the <code>Ponger</code> to take a <em>self</em> address as init-parameter, require the <a href="https://javadoc.io/doc/se.sics.kompics.basic/kompics-port-network/1.2.1/se/sics/kompics/network/Network.html" title="se.sics.kompics.network.Network"><code>Network</code></a> port and feed the new constructor arguments to the <code>Ping</code> and <code>Pong</code> classes. Since we are using the network port now for the ping-pong exchange, we can remove the requirement for the <code>PingPongPort</code>. In this first example we shall make our lives somewhat simple and use the <em>self</em> address as source and destination for both classes. This corresponds to the local reflection example mentioned above.</p>
<h4><a href="#pinger" name="pinger" class="anchor"><span class="anchor-link"></span></a>Pinger</h4>
<dl>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/kompics/kompics-scala/tree/v2.0.0/docs/src/main/java/jexamples/networking/pingpong/Pinger.java" target="_blank" title="Go to snippet source"></a><code class="language-java">package jexamples.networking.pingpong;

import se.sics.kompics.Kompics;
import se.sics.kompics.ComponentDefinition;
import se.sics.kompics.Positive;
import se.sics.kompics.Handler;
import se.sics.kompics.Start;
import se.sics.kompics.timer.*;
import se.sics.kompics.network.Network;

import java.util.UUID;

public class Pinger extends ComponentDefinition {

  Positive&lt;Network&gt; net = requires(Network.class);
  Positive&lt;Timer&gt; timer = requires(Timer.class);

  private long counter = 0;
  private UUID timerId;
  private final TAddress self;

  public Pinger(Init init) {
    this.self = init.self;
  }

  Handler&lt;Start&gt; startHandler =
      new Handler&lt;Start&gt;() {
        public void handle(Start event) {
          SchedulePeriodicTimeout spt = new SchedulePeriodicTimeout(0, 1000);
          PingTimeout timeout = new PingTimeout(spt);
          spt.setTimeoutEvent(timeout);
          trigger(spt, timer);
          timerId = timeout.getTimeoutId();
        }
      };
  Handler&lt;Pong&gt; pongHandler =
      new Handler&lt;Pong&gt;() {
        public void handle(Pong event) {
          counter++;
          logger.info(&quot;Got Pong #{}!&quot;, counter);
          if (counter &gt; 10) {
            Kompics.asyncShutdown();
          }
        }
      };
  Handler&lt;PingTimeout&gt; timeoutHandler =
      new Handler&lt;PingTimeout&gt;() {
        public void handle(PingTimeout event) {
          trigger(new Ping(self, self), net);
        }
      };

  {
    subscribe(startHandler, control);
    subscribe(pongHandler, net);
    subscribe(timeoutHandler, timer);
  }

  @Override
  public void tearDown() {
    trigger(new CancelPeriodicTimeout(timerId), timer);
  }

  public static class PingTimeout extends Timeout {
    public PingTimeout(SchedulePeriodicTimeout spt) {
      super(spt);
    }
  }

  public static class Init extends se.sics.kompics.Init&lt;Pinger&gt; {
    public final TAddress self;

    public Init(TAddress self) {
      this.self = self;
    }
  }
}</code></pre></dd>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/kompics/kompics-scala/tree/v2.0.0/docs/src/main/scala/sexamples/networking/pingpong/Pinger.scala" target="_blank" title="Go to snippet source"></a><code class="language-scala">package sexamples.networking.pingpong

import se.sics.kompics.sl._
import se.sics.kompics.network.Network
import se.sics.kompics.timer.{CancelPeriodicTimeout, SchedulePeriodicTimeout, Timeout, Timer}

import java.util.UUID

object Pinger {
  class PingTimeout(_spt: SchedulePeriodicTimeout) extends Timeout(_spt);
}
class Pinger(init: Init[Pinger]) extends ComponentDefinition {
  import Pinger.PingTimeout;

  val Init(self: TAddress) = init;

  val net = requires[Network];
  val timer = requires[Timer];

  private var counter: Long = 0L;
  private var timerId: Option[UUID] = None;

  ctrl uponEvent {
    case _: Start =&gt; {
      val spt = new SchedulePeriodicTimeout(0, 1000);
      val timeout = new PingTimeout(spt);
      spt.setTimeoutEvent(timeout);
      trigger(spt -&gt; timer);
      timerId = Some(timeout.getTimeoutId());
    }
  }

  net uponEvent {
    case _: Pong =&gt; {
      counter += 1L;
      log.info(s&quot;Got Pong #${counter}!&quot;);
      if (counter &gt; 10) {
        Kompics.asyncShutdown();
      }
    }
  }

  timer uponEvent {
    case _: PingTimeout =&gt; {
      trigger(Ping(self, self) -&gt; net);
    }
  }

  override def tearDown(): Unit = {
    timerId match {
      case Some(id) =&gt; {
        trigger(new CancelPeriodicTimeout(id) -&gt; timer);
      }
      case None =&gt; () // no cleanup necessary
    }
  }

}</code></pre></dd>
</dl>
<h4><a href="#ponger" name="ponger" class="anchor"><span class="anchor-link"></span></a>Ponger</h4>
<dl>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/kompics/kompics-scala/tree/v2.0.0/docs/src/main/java/jexamples/networking/pingpong/Ponger.java" target="_blank" title="Go to snippet source"></a><code class="language-java">package jexamples.networking.pingpong;

import se.sics.kompics.ComponentDefinition;
import se.sics.kompics.Positive;
import se.sics.kompics.Handler;
import se.sics.kompics.network.Network;

public class Ponger extends ComponentDefinition {

  Positive&lt;Network&gt; net = requires(Network.class);

  private long counter = 0;
  private final TAddress self;

  public Ponger(Init init) {
    this.self = init.self;
  }

  Handler&lt;Ping&gt; pingHandler =
      new Handler&lt;Ping&gt;() {
        public void handle(Ping event) {
          counter++;
          logger.info(&quot;Got Ping #{}!&quot;, counter);
          trigger(new Pong(self, event.getSource()), net);
        }
      };

  {
    subscribe(pingHandler, net);
  }

  public static class Init extends se.sics.kompics.Init&lt;Ponger&gt; {
    public final TAddress self;

    public Init(TAddress self) {
      this.self = self;
    }
  }
}</code></pre></dd>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/kompics/kompics-scala/tree/v2.0.0/docs/src/main/scala/sexamples/networking/pingpong/Ponger.scala" target="_blank" title="Go to snippet source"></a><code class="language-scala">package sexamples.networking.pingpong

import se.sics.kompics.sl._
import se.sics.kompics.network.Network

class Ponger(init: Init[Ponger]) extends ComponentDefinition {

  val Init(self: TAddress) = init;

  val net = requires[Network];

  private var counter: Long = 0L;

  net uponEvent {
    case ping: Ping =&gt; {
      counter += 1L;
      log.info(s&quot;Got Ping #${counter}!&quot;);
      trigger(Pong(self, ping.getSource()) -&gt; net);
    }
  }

}</code></pre></dd>
</dl>
<h4><a href="#parent" name="parent" class="anchor"><span class="anchor-link"></span></a>Parent</h4>
<p>Finally, we have to create the <code>NettyNetwork</code> component in the <code>Parent</code> class, and connect it appropriately. </p>
<dl>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/kompics/kompics-scala/tree/v2.0.0/docs/src/main/java/jexamples/networking/pingpong/Parent.java" target="_blank" title="Go to snippet source"></a><code class="language-java">package jexamples.networking.pingpong;

import se.sics.kompics.Channel;
import se.sics.kompics.ComponentDefinition;
import se.sics.kompics.Component;
import se.sics.kompics.Init;
import se.sics.kompics.timer.Timer;
import se.sics.kompics.timer.java.JavaTimer;
import se.sics.kompics.network.Network;
import se.sics.kompics.network.netty.NettyNetwork;
import se.sics.kompics.network.netty.NettyInit;

public class Parent extends ComponentDefinition {
  public Parent(Init init) {
    Component timer = create(JavaTimer.class, Init.NONE);
    Component network = create(NettyNetwork.class, new NettyInit(init.self));
    Component pinger = create(Pinger.class, new Pinger.Init(init.self));
    Component ponger = create(Ponger.class, new Ponger.Init(init.self));
    Component pinger2 = create(Pinger.class, new Pinger.Init(init.self));

    connect(pinger.getNegative(Timer.class), timer.getPositive(Timer.class), Channel.TWO_WAY);
    connect(pinger2.getNegative(Timer.class), timer.getPositive(Timer.class), Channel.TWO_WAY);

    connect(pinger.getNegative(Network.class), network.getPositive(Network.class), Channel.TWO_WAY);
    connect(
        pinger2.getNegative(Network.class), network.getPositive(Network.class), Channel.TWO_WAY);
    connect(ponger.getNegative(Network.class), network.getPositive(Network.class), Channel.TWO_WAY);
  }

  public static class Init extends se.sics.kompics.Init&lt;Parent&gt; {
    public final TAddress self;

    public Init(TAddress self) {
      this.self = self;
    }
  }
}</code></pre></dd>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/kompics/kompics-scala/tree/v2.0.0/docs/src/main/scala/sexamples/networking/pingpong/Parent.scala" target="_blank" title="Go to snippet source"></a><code class="language-scala">package sexamples.networking.pingpong

import se.sics.kompics.sl._
import se.sics.kompics.timer.Timer
import se.sics.kompics.timer.java.JavaTimer
import se.sics.kompics.network.Network
import se.sics.kompics.network.netty.{NettyInit, NettyNetwork}

class Parent(init: Init[Parent]) extends ComponentDefinition {

  val Init(self: TAddress) = init;

  val timer = create[JavaTimer];
  val network = create[NettyNetwork](new NettyInit(self));
  val pinger = create[Pinger](Init[Pinger](self));
  val pinger2 = create[Pinger](Init[Pinger](self));
  val ponger = create[Ponger](Init[Ponger](self));

  connect[Timer](timer -&gt; pinger);
  connect[Timer](timer -&gt; pinger2);

  connect[Network](network -&gt; pinger);
  connect[Network](network -&gt; pinger2);
  connect[Network](network -&gt; ponger);
}</code></pre></dd>
</dl>
<h4><a href="#main" name="main" class="anchor"><span class="anchor-link"></span></a>Main</h4>
<p>As a preparation for later, we are going to take the port for <em>self</em> address as a commandline argument in the <code>Main</code> class, and hardcode <code>127.0.0.1</code> as IP address.</p>
<dl>
  <dt>Java</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/kompics/kompics-scala/tree/v2.0.0/docs/src/main/java/jexamples/networking/pingpong/Main.java" target="_blank" title="Go to snippet source"></a><code class="language-java">package jexamples.networking.pingpong;

import se.sics.kompics.Kompics;
import java.net.InetAddress;
import java.net.UnknownHostException;

public class Main {
  public static void main(String[] args) throws InterruptedException, UnknownHostException {
    InetAddress ip = InetAddress.getLocalHost();
    int port = Integer.parseInt(args[0]);
    TAddress self = new TAddress(ip, port);
    Kompics.createAndStart(Parent.class, new Parent.Init(self), 2);
    Kompics.waitForTermination();
  }
}</code></pre></dd>
  <dt>Scala</dt>
  <dd>
  <pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/kompics/kompics-scala/tree/v2.0.0/docs/src/main/scala/sexamples/networking/pingpong/Main.scala" target="_blank" title="Go to snippet source"></a><code class="language-scala">package sexamples.networking.pingpong

import se.sics.kompics.sl._
import java.net.{InetAddress, UnknownHostException}

object Main {
  def main(args: Array[String]): Unit = {
    val ip = InetAddress.getLocalHost();
    val port = Integer.parseInt(args(0));
    val self = TAddress(ip, port);
    Kompics.createAndStart(classOf[Parent], Init[Parent](self), 2);
    Kompics.waitForTermination();
  }
}</code></pre></dd>
</dl>
<h3><a href="#execution" name="execution" class="anchor"><span class="anchor-link"></span></a>Execution</h3>
<p>At this point we can compile and run the code with a slight variation to the usual commands, since we need the port as an argument now (pick a different port if <code>34567</code> is in use on your system):</p><div class="group-java">
<pre class="prettyprint"><code class="language-bash">runMain jexamples.networking.pingpong.Main 34567
</code></pre></div><div class="group-scala">
<pre class="prettyprint"><code class="language-bash">runMain sexamples.networking.pingpong.Main 34567
</code></pre></div>
<h3><a href="#problems" name="problems" class="anchor"><span class="anchor-link"></span></a>Problems</h3>
<p>We can see from the output that our setup technically works, but we are back to the problem of getting four <code>Pong</code>s on our two <code>Ping</code>s. The reason is, of course, that we are cheating. We are running all components in the same JVM, but we are not using proper <a href="../virtual/index.html">virtual network</a> support, yet. We also do not actually want to use virtual nodes here, but instead each <code>Pinger</code> and <code>Ponger</code> should be on a different host (or at least in a different JVM).</p>
<p>Before we can fix this, though, we have to fix another problem that we do not even see, yet: None of our messages are currently serialisable.</p>
<div class="source-github">
The source code for this page can be found <a href="https://github.com/kompics/kompics-scala/tree/v2.0.0/docs/src/main/paradox/tutorial/networking/basic/messages.md">here</a>.
</div>

<div class="nav-next">
<p><strong>Next:</strong> <a href="../../../tutorial/networking/basic/serialisation.html">Serialisation</a></p>
</div>
</div>
<div class="large-3 show-for-large column" data-sticky-container>
<nav class="sidebar sticky" data-sticky data-anchor="docs" data-sticky-on="large">
<div class="page-nav">
<div class="nav-title">On this page:</div>
<div class="nav-toc">
<ul>
  <li><a href="../../../tutorial/networking/basic/messages.html#messages-addresses-and-headers" class="header">Messages, Addresses, and Headers</a>
  <ul>
    <li><a href="../../../tutorial/networking/basic/messages.html#header" class="header">Header</a></li>
    <li><a href="../../../tutorial/networking/basic/messages.html#address" class="header">Address</a></li>
    <li><a href="../../../tutorial/networking/basic/messages.html#implementations" class="header">Implementations</a></li>
    <li><a href="../../../tutorial/networking/basic/messages.html#execution" class="header">Execution</a></li>
    <li><a href="../../../tutorial/networking/basic/messages.html#problems" class="header">Problems</a></li>
  </ul></li>
</ul>
</div>
</div>
</nav>
</div>
</div>

</section>
</div>

</div>

<footer class="site-footer">

<section class="site-footer-nav">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 medium-4 large-3 text-center column">
<div class="nav-links">
<ul>
<!-- <li><a href="https://www.example.com/products/">Products</a> -->
</ul>
</div>
</div>

</div>
</div>
</div>
</section>

<section class="site-footer-base">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 text-center large-9 column">

<!--
<div class="copyright">
<span class="text">&copy; 2020</span>
<a href="https://www.example.com" class="logo">logo</a>
</div>
-->
</div>

</div>
</div>
</div>
</section>
</footer>

</div>
</div>
</div>
</body>

<script type="text/javascript" src="../../../lib/foundation/dist/foundation.min.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../../../js/magellan.js"></script>

<style type="text/css">@import "../../../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../../../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../../../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>
<script type="text/javascript">jQuery(function(jq){initOldVersionWarnings(jq, '2.0.0', '')});</script>


</html>
